

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Merge/Join Tables (VLOOKUP) &#8212; From Excel to Pandas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Split a Table into Groups" href="03.02_group_by.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">From Excel to Pandas</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to the complete tutorial from Excel to Pandas
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started.html">
   Install Locally
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started.html#open-in-binder-colab">
   Open in Binder/Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started.html#open-in-visual-studio-code">
   Open in Visual Studio Code
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Loading Data
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01%20-%20loading%20files.html">
   Loading Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01.02%20-%20loading%20data%20from%20HTML.html">
   Reading Data from Web Sites
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01.03_loading_data_from_API.html">
   Reading Data from External API
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Adding Columns
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="02.01_Adding_New_Columns.html">
   Adding New Columns
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02.02_more_excel_functions.html">
   Adding Various Columns with Functions
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Table Aggregation and Reshaping
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="03.01_pivot_tables.html">
   Creating a Pivot Table
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03.02_group_by.html">
   Split a Table into Groups
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Table Enrichment with Merge
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Merge/Join Tables (VLOOKUP)
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/03.03_merge.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/notebooks/03.03_merge.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/notebooks/03.03_merge.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-lookup-data">
   Loading lookup data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lookup-data-exploration">
   Lookup Data Exploration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#counting-values">
   Counting Values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sorting-values">
   Sorting Values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualization-of-the-data">
   Visualization of the data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-the-main-data">
   Loading the main data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-the-tables">
   Joining the tables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#geographic-mapping">
   Geographic Mapping
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="merge-join-tables-vlookup">
<h1>Merge/Join Tables (VLOOKUP)<a class="headerlink" href="#merge-join-tables-vlookup" title="Permalink to this headline">¶</a></h1>
<p>The <em>merge</em> function mimics the functionality of JOIN in SQL queries and replaces the VLOOKUP functionality in Excel. It is one of the most powerful and useful functions for dataframes in Pandas. The main idea is to:</p>
<ul class="simple">
<li><p><strong>join</strong> two (or more) dataframe table using similar keys in each of the tables.</p></li>
<li><p><strong>enrich</strong> tables with loopup data</p></li>
<li><p><strong>validate</strong> the match values of the key columns in the tables</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="loading-lookup-data">
<h2>Loading lookup data<a class="headerlink" href="#loading-lookup-data" title="Permalink to this headline">¶</a></h2>
<p>For this example, we will take one of the common lookup data, zip code. The loopup is not trivial as there are a few tousands (more than 33,000 as you can see below) of values and a simple Excel file will struggle to do it efficently and quickly.</p>
<p>We will start with loading the loopup data from <a class="reference external" href="https://simplemaps.com/data/us-zips">Simple Maps</a>, which I’ve downloaded to a public S3 bucket.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://mlguy-public.s3-eu-west-1.amazonaws.com/excel2pandas/chapter3/simplemaps_uszips_basicv1/uszips.csv&#39;</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">response</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Response [200]&gt;
</pre></div>
</div>
</div>
</div>
<p>The CSV file is read through a URL and therefore, we need to convert the text of the response to a simple string as we get when we read a local file. For that we will use the StringIO functionality as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zip_lookup</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span>
    <span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">StringIO</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">zip_lookup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>zip</th>
      <th>lat</th>
      <th>lng</th>
      <th>city</th>
      <th>state_id</th>
      <th>state_name</th>
      <th>zcta</th>
      <th>parent_zcta</th>
      <th>population</th>
      <th>density</th>
      <th>county_fips</th>
      <th>county_name</th>
      <th>county_weights</th>
      <th>county_names_all</th>
      <th>county_fips_all</th>
      <th>imprecise</th>
      <th>military</th>
      <th>timezone</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>601</td>
      <td>18.18004</td>
      <td>-66.75218</td>
      <td>Adjuntas</td>
      <td>PR</td>
      <td>Puerto Rico</td>
      <td>True</td>
      <td>NaN</td>
      <td>17242</td>
      <td>111.4</td>
      <td>72001</td>
      <td>Adjuntas</td>
      <td>{'72001':99.43,'72141':0.57}</td>
      <td>Adjuntas|Utuado</td>
      <td>72001|72141</td>
      <td>False</td>
      <td>False</td>
      <td>America/Puerto_Rico</td>
    </tr>
    <tr>
      <th>1</th>
      <td>602</td>
      <td>18.36073</td>
      <td>-67.17517</td>
      <td>Aguada</td>
      <td>PR</td>
      <td>Puerto Rico</td>
      <td>True</td>
      <td>NaN</td>
      <td>38442</td>
      <td>523.5</td>
      <td>72003</td>
      <td>Aguada</td>
      <td>{'72003':100}</td>
      <td>Aguada</td>
      <td>72003</td>
      <td>False</td>
      <td>False</td>
      <td>America/Puerto_Rico</td>
    </tr>
    <tr>
      <th>2</th>
      <td>603</td>
      <td>18.45439</td>
      <td>-67.12202</td>
      <td>Aguadilla</td>
      <td>PR</td>
      <td>Puerto Rico</td>
      <td>True</td>
      <td>NaN</td>
      <td>48814</td>
      <td>667.9</td>
      <td>72005</td>
      <td>Aguadilla</td>
      <td>{'72005':100}</td>
      <td>Aguadilla</td>
      <td>72005</td>
      <td>False</td>
      <td>False</td>
      <td>America/Puerto_Rico</td>
    </tr>
    <tr>
      <th>3</th>
      <td>606</td>
      <td>18.16724</td>
      <td>-66.93828</td>
      <td>Maricao</td>
      <td>PR</td>
      <td>Puerto Rico</td>
      <td>True</td>
      <td>NaN</td>
      <td>6437</td>
      <td>60.4</td>
      <td>72093</td>
      <td>Maricao</td>
      <td>{'72093':94.88,'72121':1.35,'72153':3.78}</td>
      <td>Maricao|Yauco|Sabana Grande</td>
      <td>72093|72153|72121</td>
      <td>False</td>
      <td>False</td>
      <td>America/Puerto_Rico</td>
    </tr>
    <tr>
      <th>4</th>
      <td>610</td>
      <td>18.29032</td>
      <td>-67.12243</td>
      <td>Anasco</td>
      <td>PR</td>
      <td>Puerto Rico</td>
      <td>True</td>
      <td>NaN</td>
      <td>27073</td>
      <td>312.0</td>
      <td>72011</td>
      <td>AÃ±asco</td>
      <td>{'72003':0.55,'72011':99.45}</td>
      <td>AÃ±asco|Aguada</td>
      <td>72011|72003</td>
      <td>False</td>
      <td>False</td>
      <td>America/Puerto_Rico</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>33092</th>
      <td>99923</td>
      <td>55.97796</td>
      <td>-130.03671</td>
      <td>Hyder</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>15</td>
      <td>2.1</td>
      <td>2198</td>
      <td>Prince of Wales-Hyder</td>
      <td>{'02198':100}</td>
      <td>Prince of Wales-Hyder</td>
      <td>02198</td>
      <td>False</td>
      <td>False</td>
      <td>America/Sitka</td>
    </tr>
    <tr>
      <th>33093</th>
      <td>99925</td>
      <td>55.55767</td>
      <td>-132.97627</td>
      <td>Klawock</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>927</td>
      <td>5.7</td>
      <td>2198</td>
      <td>Prince of Wales-Hyder</td>
      <td>{'02198':100}</td>
      <td>Prince of Wales-Hyder</td>
      <td>02198</td>
      <td>False</td>
      <td>False</td>
      <td>America/Sitka</td>
    </tr>
    <tr>
      <th>33094</th>
      <td>99926</td>
      <td>55.12617</td>
      <td>-131.48928</td>
      <td>Metlakatla</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>1635</td>
      <td>4.2</td>
      <td>2198</td>
      <td>Prince of Wales-Hyder</td>
      <td>{'02198':100}</td>
      <td>Prince of Wales-Hyder</td>
      <td>02198</td>
      <td>False</td>
      <td>False</td>
      <td>America/Metlakatla</td>
    </tr>
    <tr>
      <th>33095</th>
      <td>99927</td>
      <td>56.25100</td>
      <td>-133.37571</td>
      <td>Point Baker</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>38</td>
      <td>0.2</td>
      <td>2198</td>
      <td>Prince of Wales-Hyder</td>
      <td>{'02198':100}</td>
      <td>Prince of Wales-Hyder</td>
      <td>02198</td>
      <td>False</td>
      <td>False</td>
      <td>America/Sitka</td>
    </tr>
    <tr>
      <th>33096</th>
      <td>99929</td>
      <td>56.36950</td>
      <td>-131.93648</td>
      <td>Wrangell</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>2484</td>
      <td>0.4</td>
      <td>2275</td>
      <td>Wrangell</td>
      <td>{'02275':100}</td>
      <td>Wrangell</td>
      <td>02275</td>
      <td>False</td>
      <td>False</td>
      <td>America/Sitka</td>
    </tr>
  </tbody>
</table>
<p>33097 rows × 18 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="lookup-data-exploration">
<h2>Lookup Data Exploration<a class="headerlink" href="#lookup-data-exploration" title="Permalink to this headline">¶</a></h2>
<p>The table above shows us the type of data that we can get from enrichment based on the zip code, including city, state, latitude, longitude, population count and density.</p>
<p>We can explore the values that we have in this table, before we start to use it for enrichment.</p>
</div>
<div class="section" id="counting-values">
<h2>Counting Values<a class="headerlink" href="#counting-values" title="Permalink to this headline">¶</a></h2>
<p>The simplest aggregation function for each group is the <em>size</em>. How many zip codes do we have in each state?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">zip_lookup</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;state_name&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>state_name
Alabama                  642
Alaska                   238
Arizona                  405
Arkansas                 591
California              1761
Colorado                 525
Connecticut              282
Delaware                  67
District of Columbia      52
Florida                  981
Georgia                  735
Hawaii                    94
Idaho                    277
Illinois                1383
Indiana                  775
Iowa                     934
Kansas                   697
Kentucky                 767
Louisiana                515
Maine                    432
Maryland                 468
Massachusetts            537
Michigan                 986
Minnesota                884
Mississippi              423
Missouri                1022
Montana                  361
Nebraska                 581
Nevada                   175
New Hampshire            248
New Jersey               595
New Mexico               368
New York                1794
North Carolina           808
North Dakota             383
Ohio                    1195
Oklahoma                 648
Oregon                   417
Pennsylvania            1795
Puerto Rico              131
Rhode Island              77
South Carolina           424
South Dakota             371
Tennessee                628
Texas                   1935
Utah                     287
Vermont                  255
Virginia                 896
Washington               596
West Virginia            706
Wisconsin                772
Wyoming                  178
dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sorting-values">
<h2>Sorting Values<a class="headerlink" href="#sorting-values" title="Permalink to this headline">¶</a></h2>
<p>To sort the values is also simple with <em>sort_value()</em> function, and see the population size of each state (based on the zip code lookup data):</p>
<ul class="simple">
<li><p>Start with the zip lookup data above</p></li>
<li><p>Group the row by <em>state_name</em> and take only the <em>population</em> values</p></li>
<li><p>Sum up all the population values for each zip code area in the state Group</p></li>
<li><p>Sort the states by the accumulated population value in descending order</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">us_population_distribution</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">zip_lookup</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;state_name&#39;</span><span class="p">)[</span><span class="s1">&#39;population&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">us_population_distribution</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>state_name
California              39140219
Texas                   27884135
Florida                 20594164
New York                19618323
Illinois                12821487
Pennsylvania            12790950
Ohio                    11639989
Georgia                 10297534
North Carolina          10155624
Michigan                 9957465
New Jersey               8881845
Virginia                 8414042
Washington               7280023
Arizona                  6949259
Massachusetts            6830133
Tennessee                6644470
Indiana                  6637220
Missouri                 6090358
Maryland                 6003435
Wisconsin                5777892
Colorado                 5531233
Minnesota                5527473
South Carolina           4955925
Alabama                  4864630
Louisiana                4663243
Kentucky                 4446667
Oregon                   4081732
Oklahoma                 3918473
Connecticut              3581504
Puerto Rico              3384779
Iowa                     3133061
Utah                     3043806
Arkansas                 2990472
Mississippi              2988710
Nevada                   2923171
Kansas                   2908448
New Mexico               2089570
Nebraska                 1904901
West Virginia            1828786
Idaho                    1687214
Hawaii                   1422019
New Hampshire            1343673
Maine                    1332721
Rhode Island             1056611
Montana                  1042359
Delaware                  949495
South Dakota              864012
North Dakota              751250
Alaska                    737979
District of Columbia      684390
Vermont                   624977
Wyoming                   582091
Name: population, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualization-of-the-data">
<h2>Visualization of the data<a class="headerlink" href="#visualization-of-the-data" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">us_population_distribution</span>
    <span class="o">.</span><span class="n">plot</span>
    <span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03.03_merge_12_0.png" src="../_images/03.03_merge_12_0.png" />
</div>
</div>
</div>
<div class="section" id="loading-the-main-data">
<h2>Loading the main data<a class="headerlink" href="#loading-the-main-data" title="Permalink to this headline">¶</a></h2>
<p>We will take the data about brewries in the US that we used in one of the previous lessson, and enrich it with the data from the zip codes table. We will load it from the local file after we retried the data from the API before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">breweries_data</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/us_breweries.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">breweries_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>brewery_type</th>
      <th>street</th>
      <th>address_2</th>
      <th>address_3</th>
      <th>city</th>
      <th>state</th>
      <th>county_province</th>
      <th>postal_code</th>
      <th>country</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>phone</th>
      <th>website_url</th>
      <th>updated_at</th>
      <th>created_at</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>Avondale Brewing Co</td>
      <td>micro</td>
      <td>201 41st St S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35222-1932</td>
      <td>United States</td>
      <td>-86.774322</td>
      <td>33.524521</td>
      <td>2.057775e+09</td>
      <td>http://www.avondalebrewing.com</td>
      <td>2018-08-23T23:19:57.825Z</td>
      <td>2018-07-24T01:32:47.255Z</td>
    </tr>
    <tr>
      <th>1</th>
      <td>44</td>
      <td>Trim Tab Brewing</td>
      <td>micro</td>
      <td>2721 5th Ave S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35233-3401</td>
      <td>United States</td>
      <td>-86.791400</td>
      <td>33.512849</td>
      <td>2.057031e+09</td>
      <td>http://www.trimtabbrewing.com</td>
      <td>2018-08-23T23:20:31.423Z</td>
      <td>2018-07-24T01:32:47.815Z</td>
    </tr>
    <tr>
      <th>2</th>
      <td>46</td>
      <td>Yellowhammer Brewery</td>
      <td>micro</td>
      <td>2600 Clinton Ave W</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Huntsville</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35805-3046</td>
      <td>United States</td>
      <td>-86.593201</td>
      <td>34.727752</td>
      <td>2.569756e+09</td>
      <td>http://www.yellowhammerbrewery.com</td>
      <td>2018-08-23T23:20:33.102Z</td>
      <td>2018-07-24T01:32:47.838Z</td>
    </tr>
    <tr>
      <th>3</th>
      <td>55</td>
      <td>Bearpaw River Brewing Co</td>
      <td>micro</td>
      <td>4605 E Palmer Wasilla Hwy</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Wasilla</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99654-7679</td>
      <td>United States</td>
      <td>-149.412710</td>
      <td>61.575269</td>
      <td>NaN</td>
      <td>http://bearpawriverbrewing.com</td>
      <td>2018-08-23T23:20:40.743Z</td>
      <td>2018-07-24T01:32:47.967Z</td>
    </tr>
    <tr>
      <th>4</th>
      <td>76</td>
      <td>King Street Brewing Co</td>
      <td>micro</td>
      <td>9050 King Street</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Anchorage</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99515</td>
      <td>United States</td>
      <td>-149.879076</td>
      <td>61.138489</td>
      <td>9.073365e+09</td>
      <td>http://www.kingstreetbrewing.com</td>
      <td>2018-08-23T23:20:57.179Z</td>
      <td>2018-07-24T01:32:48.301Z</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can see that the postal code is sometimes in the longer format (for example, <em>35222-1932</em>) compare to the zip codes that we have in our lookup table (for example, 35222). We will convert them to the shorter format by taking the first 5 characters ([:5]) of the string of the postal_code column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">breweries_data_with_zip</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">breweries_data</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">zip_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">postal_code</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">breweries_data_with_zip</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>brewery_type</th>
      <th>street</th>
      <th>address_2</th>
      <th>address_3</th>
      <th>city</th>
      <th>state</th>
      <th>county_province</th>
      <th>postal_code</th>
      <th>country</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>phone</th>
      <th>website_url</th>
      <th>updated_at</th>
      <th>created_at</th>
      <th>zip_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>Avondale Brewing Co</td>
      <td>micro</td>
      <td>201 41st St S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35222-1932</td>
      <td>United States</td>
      <td>-86.774322</td>
      <td>33.524521</td>
      <td>2.057775e+09</td>
      <td>http://www.avondalebrewing.com</td>
      <td>2018-08-23T23:19:57.825Z</td>
      <td>2018-07-24T01:32:47.255Z</td>
      <td>35222</td>
    </tr>
    <tr>
      <th>1</th>
      <td>44</td>
      <td>Trim Tab Brewing</td>
      <td>micro</td>
      <td>2721 5th Ave S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35233-3401</td>
      <td>United States</td>
      <td>-86.791400</td>
      <td>33.512849</td>
      <td>2.057031e+09</td>
      <td>http://www.trimtabbrewing.com</td>
      <td>2018-08-23T23:20:31.423Z</td>
      <td>2018-07-24T01:32:47.815Z</td>
      <td>35233</td>
    </tr>
    <tr>
      <th>2</th>
      <td>46</td>
      <td>Yellowhammer Brewery</td>
      <td>micro</td>
      <td>2600 Clinton Ave W</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Huntsville</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35805-3046</td>
      <td>United States</td>
      <td>-86.593201</td>
      <td>34.727752</td>
      <td>2.569756e+09</td>
      <td>http://www.yellowhammerbrewery.com</td>
      <td>2018-08-23T23:20:33.102Z</td>
      <td>2018-07-24T01:32:47.838Z</td>
      <td>35805</td>
    </tr>
    <tr>
      <th>3</th>
      <td>55</td>
      <td>Bearpaw River Brewing Co</td>
      <td>micro</td>
      <td>4605 E Palmer Wasilla Hwy</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Wasilla</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99654-7679</td>
      <td>United States</td>
      <td>-149.412710</td>
      <td>61.575269</td>
      <td>NaN</td>
      <td>http://bearpawriverbrewing.com</td>
      <td>2018-08-23T23:20:40.743Z</td>
      <td>2018-07-24T01:32:47.967Z</td>
      <td>99654</td>
    </tr>
    <tr>
      <th>4</th>
      <td>76</td>
      <td>King Street Brewing Co</td>
      <td>micro</td>
      <td>9050 King Street</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Anchorage</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99515</td>
      <td>United States</td>
      <td>-149.879076</td>
      <td>61.138489</td>
      <td>9.073365e+09</td>
      <td>http://www.kingstreetbrewing.com</td>
      <td>2018-08-23T23:20:57.179Z</td>
      <td>2018-07-24T01:32:48.301Z</td>
      <td>99515</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="joining-the-tables">
<h2>Joining the tables<a class="headerlink" href="#joining-the-tables" title="Permalink to this headline">¶</a></h2>
<p>The joining of the table is based on a joined key. In this case we want to use the 5-digits zip code as the lookup or join key. In the previous step with shorten the longer zip codes to the shorter 5 digits format, and now we will make sure that the lookup table also have it in the same format.</p>
<ul class="simple">
<li><p>Start with the zip loopup table</p></li>
<li><p>Add a column zip_code that is based on the value of the column <em>zip</em></p></li>
<li><p>Convert the numeric value into string (<em>astype(str)</em>),</p></li>
<li><p>Pad the string with zeros when the number is shorter than 5 digits (<em>zfill(5)</em>).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zip_lookup_as_string</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">zip_lookup</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">zip_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">zip</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span>
        <span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The join itself is simple.</p>
<ul class="simple">
<li><p>Start with the breweries table that you want to enrich</p></li>
<li><p>Join using <em>merge</em> with the second zip loopup table</p></li>
<li><p>Define the key column with the same name (zip_code), and we use it using the <em>on</em> argument</p></li>
<li><p>Lastly, we want to have all breweries, even if we don’t find the zip code in the lookup table. Therefore, we are using <em>LEFT</em> join using the <em>how</em> argument.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">enriched_breweries_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">breweries_data_with_zip</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">zip_lookup_as_string</span><span class="p">,</span> 
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;zip_code&#39;</span><span class="p">,</span> 
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We have now many more columns as all the columns of both tables are joined to the enriched table. We will ask the Jupyter notebook to show us all the columns by removing the default maximum number of columns to display.</p>
<p>In the table below we can see all the columns. If the same column name is found in both tables and it wasn’t the column that was used for the join or merge, the column of first (“left”) table will be appended with x (city_x, for example), and the column of the second (“right”) table will be appended with y (city_y, for example).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">enriched_breweries_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>brewery_type</th>
      <th>street</th>
      <th>address_2</th>
      <th>address_3</th>
      <th>city_x</th>
      <th>state</th>
      <th>county_province</th>
      <th>postal_code</th>
      <th>country</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>phone</th>
      <th>website_url</th>
      <th>updated_at</th>
      <th>created_at</th>
      <th>zip_code</th>
      <th>zip</th>
      <th>lat</th>
      <th>lng</th>
      <th>city_y</th>
      <th>state_id</th>
      <th>state_name</th>
      <th>zcta</th>
      <th>parent_zcta</th>
      <th>population</th>
      <th>density</th>
      <th>county_fips</th>
      <th>county_name</th>
      <th>county_weights</th>
      <th>county_names_all</th>
      <th>county_fips_all</th>
      <th>imprecise</th>
      <th>military</th>
      <th>timezone</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>Avondale Brewing Co</td>
      <td>micro</td>
      <td>201 41st St S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35222-1932</td>
      <td>United States</td>
      <td>-86.774322</td>
      <td>33.524521</td>
      <td>2.057775e+09</td>
      <td>http://www.avondalebrewing.com</td>
      <td>2018-08-23T23:19:57.825Z</td>
      <td>2018-07-24T01:32:47.255Z</td>
      <td>35222</td>
      <td>35222.0</td>
      <td>33.52409</td>
      <td>-86.77025</td>
      <td>Birmingham</td>
      <td>AL</td>
      <td>Alabama</td>
      <td>True</td>
      <td>NaN</td>
      <td>9033.0</td>
      <td>815.8</td>
      <td>1073.0</td>
      <td>Jefferson</td>
      <td>{'01073':100}</td>
      <td>Jefferson</td>
      <td>01073</td>
      <td>False</td>
      <td>False</td>
      <td>America/Chicago</td>
    </tr>
    <tr>
      <th>1</th>
      <td>44</td>
      <td>Trim Tab Brewing</td>
      <td>micro</td>
      <td>2721 5th Ave S</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Birmingham</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35233-3401</td>
      <td>United States</td>
      <td>-86.791400</td>
      <td>33.512849</td>
      <td>2.057031e+09</td>
      <td>http://www.trimtabbrewing.com</td>
      <td>2018-08-23T23:20:31.423Z</td>
      <td>2018-07-24T01:32:47.815Z</td>
      <td>35233</td>
      <td>35233.0</td>
      <td>33.50876</td>
      <td>-86.80194</td>
      <td>Birmingham</td>
      <td>AL</td>
      <td>Alabama</td>
      <td>True</td>
      <td>NaN</td>
      <td>1715.0</td>
      <td>300.7</td>
      <td>1073.0</td>
      <td>Jefferson</td>
      <td>{'01073':100}</td>
      <td>Jefferson</td>
      <td>01073</td>
      <td>False</td>
      <td>False</td>
      <td>America/Chicago</td>
    </tr>
    <tr>
      <th>2</th>
      <td>46</td>
      <td>Yellowhammer Brewery</td>
      <td>micro</td>
      <td>2600 Clinton Ave W</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Huntsville</td>
      <td>Alabama</td>
      <td>NaN</td>
      <td>35805-3046</td>
      <td>United States</td>
      <td>-86.593201</td>
      <td>34.727752</td>
      <td>2.569756e+09</td>
      <td>http://www.yellowhammerbrewery.com</td>
      <td>2018-08-23T23:20:33.102Z</td>
      <td>2018-07-24T01:32:47.838Z</td>
      <td>35805</td>
      <td>35805.0</td>
      <td>34.70858</td>
      <td>-86.62125</td>
      <td>Huntsville</td>
      <td>AL</td>
      <td>Alabama</td>
      <td>True</td>
      <td>NaN</td>
      <td>21200.0</td>
      <td>949.7</td>
      <td>1089.0</td>
      <td>Madison</td>
      <td>{'01089':100}</td>
      <td>Madison</td>
      <td>01089</td>
      <td>False</td>
      <td>False</td>
      <td>America/Chicago</td>
    </tr>
    <tr>
      <th>3</th>
      <td>55</td>
      <td>Bearpaw River Brewing Co</td>
      <td>micro</td>
      <td>4605 E Palmer Wasilla Hwy</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Wasilla</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99654-7679</td>
      <td>United States</td>
      <td>-149.412710</td>
      <td>61.575269</td>
      <td>NaN</td>
      <td>http://bearpawriverbrewing.com</td>
      <td>2018-08-23T23:20:40.743Z</td>
      <td>2018-07-24T01:32:47.967Z</td>
      <td>99654</td>
      <td>99654.0</td>
      <td>61.45483</td>
      <td>-149.90045</td>
      <td>Wasilla</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>62135.0</td>
      <td>40.4</td>
      <td>2170.0</td>
      <td>Matanuska-Susitna</td>
      <td>{'02170':100}</td>
      <td>Matanuska-Susitna</td>
      <td>02170</td>
      <td>False</td>
      <td>False</td>
      <td>America/Anchorage</td>
    </tr>
    <tr>
      <th>4</th>
      <td>76</td>
      <td>King Street Brewing Co</td>
      <td>micro</td>
      <td>9050 King Street</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Anchorage</td>
      <td>Alaska</td>
      <td>NaN</td>
      <td>99515</td>
      <td>United States</td>
      <td>-149.879076</td>
      <td>61.138489</td>
      <td>9.073365e+09</td>
      <td>http://www.kingstreetbrewing.com</td>
      <td>2018-08-23T23:20:57.179Z</td>
      <td>2018-07-24T01:32:48.301Z</td>
      <td>99515</td>
      <td>99515.0</td>
      <td>61.11739</td>
      <td>-149.88889</td>
      <td>Anchorage</td>
      <td>AK</td>
      <td>Alaska</td>
      <td>True</td>
      <td>NaN</td>
      <td>23402.0</td>
      <td>818.8</td>
      <td>2020.0</td>
      <td>Anchorage</td>
      <td>{'02020':100}</td>
      <td>Anchorage</td>
      <td>02020</td>
      <td>False</td>
      <td>False</td>
      <td>America/Anchorage</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7445</th>
      <td>345</td>
      <td>Barrel Brothers Brewing Company</td>
      <td>micro</td>
      <td>399 Business Park Ct Ste 506</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Windsor</td>
      <td>California</td>
      <td>NaN</td>
      <td>95492-6652</td>
      <td>United States</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.076969e+09</td>
      <td>http://www.barrelbrothersbrewing.com</td>
      <td>2018-08-11T21:35:55.480Z</td>
      <td>2018-07-24T01:32:52.148Z</td>
      <td>95492</td>
      <td>95492.0</td>
      <td>38.53034</td>
      <td>-122.81716</td>
      <td>Windsor</td>
      <td>CA</td>
      <td>California</td>
      <td>True</td>
      <td>NaN</td>
      <td>29920.0</td>
      <td>579.0</td>
      <td>6097.0</td>
      <td>Sonoma</td>
      <td>{'06097':100}</td>
      <td>Sonoma</td>
      <td>06097</td>
      <td>False</td>
      <td>False</td>
      <td>America/Los_Angeles</td>
    </tr>
    <tr>
      <th>7446</th>
      <td>352</td>
      <td>Bay Bridge Brewing Co</td>
      <td>micro</td>
      <td>688 Marsat Ct Ste B</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Chula Vista</td>
      <td>California</td>
      <td>NaN</td>
      <td>91911-4697</td>
      <td>United States</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.199347e+09</td>
      <td>http://www.baybridgebrewing.com</td>
      <td>2018-08-11T21:35:55.704Z</td>
      <td>2018-07-24T01:32:52.238Z</td>
      <td>91911</td>
      <td>91911.0</td>
      <td>32.60738</td>
      <td>-117.05405</td>
      <td>Chula Vista</td>
      <td>CA</td>
      <td>California</td>
      <td>True</td>
      <td>NaN</td>
      <td>85365.0</td>
      <td>2736.2</td>
      <td>6073.0</td>
      <td>San Diego</td>
      <td>{'06073':100}</td>
      <td>San Diego</td>
      <td>06073</td>
      <td>False</td>
      <td>False</td>
      <td>America/Los_Angeles</td>
    </tr>
    <tr>
      <th>7447</th>
      <td>367</td>
      <td>Benchmark Brewing Co</td>
      <td>micro</td>
      <td>6190 Fairmount Ave Ste G</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>San Diego</td>
      <td>California</td>
      <td>NaN</td>
      <td>92120-3428</td>
      <td>United States</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.197953e+09</td>
      <td>http://www.benchmarkbrewing.com</td>
      <td>2018-08-11T21:35:56.157Z</td>
      <td>2018-07-24T01:32:52.420Z</td>
      <td>92120</td>
      <td>92120.0</td>
      <td>32.79468</td>
      <td>-117.07114</td>
      <td>San Diego</td>
      <td>CA</td>
      <td>California</td>
      <td>True</td>
      <td>NaN</td>
      <td>29142.0</td>
      <td>1501.7</td>
      <td>6073.0</td>
      <td>San Diego</td>
      <td>{'06073':100}</td>
      <td>San Diego</td>
      <td>06073</td>
      <td>False</td>
      <td>False</td>
      <td>America/Los_Angeles</td>
    </tr>
    <tr>
      <th>7448</th>
      <td>477</td>
      <td>Chino Valley Brewery</td>
      <td>micro</td>
      <td>1609 E. Grove Ave, Unit 109</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Ontario</td>
      <td>California</td>
      <td>NaN</td>
      <td>91761-5786</td>
      <td>United States</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.512917e+09</td>
      <td>http://www.chinovalleybrewery.com</td>
      <td>2018-08-11T21:35:59.331Z</td>
      <td>2018-07-24T01:32:53.774Z</td>
      <td>91761</td>
      <td>91761.0</td>
      <td>34.03459</td>
      <td>-117.59212</td>
      <td>Ontario</td>
      <td>CA</td>
      <td>California</td>
      <td>True</td>
      <td>NaN</td>
      <td>61124.0</td>
      <td>754.0</td>
      <td>6071.0</td>
      <td>San Bernardino</td>
      <td>{'06071':100}</td>
      <td>San Bernardino</td>
      <td>06071</td>
      <td>False</td>
      <td>False</td>
      <td>America/Los_Angeles</td>
    </tr>
    <tr>
      <th>7449</th>
      <td>509</td>
      <td>Crooked Goat Brewing</td>
      <td>micro</td>
      <td>120 Morris St Ste 120</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Sebastopol</td>
      <td>California</td>
      <td>NaN</td>
      <td>95472-3867</td>
      <td>United States</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.078274e+09</td>
      <td>http://www.crookedgoatbrewing.com</td>
      <td>2018-08-11T21:36:00.652Z</td>
      <td>2018-07-24T01:32:54.205Z</td>
      <td>95472</td>
      <td>95472.0</td>
      <td>38.39817</td>
      <td>-122.86574</td>
      <td>Sebastopol</td>
      <td>CA</td>
      <td>California</td>
      <td>True</td>
      <td>NaN</td>
      <td>30762.0</td>
      <td>157.8</td>
      <td>6097.0</td>
      <td>Sonoma</td>
      <td>{'06097':100}</td>
      <td>Sonoma</td>
      <td>06097</td>
      <td>False</td>
      <td>False</td>
      <td>America/Los_Angeles</td>
    </tr>
  </tbody>
</table>
<p>7450 rows × 36 columns</p>
</div></div></div>
</div>
<p>Now, that we have the enriched table, we can analyze the joined data and explore the different counties across the US:</p>
<ul class="simple">
<li><p>Start with the enriched breweries data above</p></li>
<li><p>Group the breweries by county_name</p></li>
<li><p>For each group add the State ID</p></li>
<li><p>count the number of breweries,</p></li>
<li><p>sum up the populations of each zip code area in each group</p></li>
<li><p>and calculate the average population density in the county</p></li>
<li><p>Sort that list by the population size</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;county_name&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> 
        <span class="n">brewry_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
        <span class="n">population_sum</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span>
        <span class="n">density_average</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;population_sum&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>brewry_count</th>
      <th>population_sum</th>
      <th>density_average</th>
    </tr>
    <tr>
      <th>county_name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>San Diego</th>
      <td>CA</td>
      <td>154</td>
      <td>6059002.0</td>
      <td>1670.298052</td>
    </tr>
    <tr>
      <th>Los Angeles</th>
      <td>CA</td>
      <td>126</td>
      <td>4529555.0</td>
      <td>2834.088095</td>
    </tr>
    <tr>
      <th>Cook</th>
      <td>IL</td>
      <td>98</td>
      <td>4510406.0</td>
      <td>5011.613265</td>
    </tr>
    <tr>
      <th>King</th>
      <td>WA</td>
      <td>117</td>
      <td>3519428.0</td>
      <td>2407.258120</td>
    </tr>
    <tr>
      <th>Orange</th>
      <td>CA</td>
      <td>88</td>
      <td>3261503.0</td>
      <td>1574.422727</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Clearwater</th>
      <td>ID</td>
      <td>1</td>
      <td>164.0</td>
      <td>5.800000</td>
    </tr>
    <tr>
      <th>Koochiching</th>
      <td>MN</td>
      <td>1</td>
      <td>151.0</td>
      <td>334.400000</td>
    </tr>
    <tr>
      <th>Harding</th>
      <td>NM</td>
      <td>1</td>
      <td>139.0</td>
      <td>0.100000</td>
    </tr>
    <tr>
      <th>Wabasha</th>
      <td>MN</td>
      <td>1</td>
      <td>88.0</td>
      <td>29.500000</td>
    </tr>
    <tr>
      <th>Keweenaw</th>
      <td>MI</td>
      <td>1</td>
      <td>87.0</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
<p>959 rows × 4 columns</p>
</div></div></div>
</div>
<p>We can see that <em>san Diego</em> is the largest county in terms of population and also a beer county with 154 different brewries in it.</p>
<p>Let’s change the sort key to find the counties with the most breweries</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;county_name&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> 
        <span class="n">brewry_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
        <span class="n">population_sum</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span>
        <span class="n">density_average</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;brewry_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>brewry_count</th>
      <th>population_sum</th>
      <th>density_average</th>
    </tr>
    <tr>
      <th>county_name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>San Diego</th>
      <td>CA</td>
      <td>154</td>
      <td>6059002.0</td>
      <td>1670.298052</td>
    </tr>
    <tr>
      <th>Los Angeles</th>
      <td>CA</td>
      <td>126</td>
      <td>4529555.0</td>
      <td>2834.088095</td>
    </tr>
    <tr>
      <th>King</th>
      <td>WA</td>
      <td>117</td>
      <td>3519428.0</td>
      <td>2407.258120</td>
    </tr>
    <tr>
      <th>Cook</th>
      <td>IL</td>
      <td>98</td>
      <td>4510406.0</td>
      <td>5011.613265</td>
    </tr>
    <tr>
      <th>Jefferson</th>
      <td>AL</td>
      <td>93</td>
      <td>1951501.0</td>
      <td>770.348387</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Flagler</th>
      <td>FL</td>
      <td>1</td>
      <td>43813.0</td>
      <td>247.300000</td>
    </tr>
    <tr>
      <th>Fond du Lac</th>
      <td>WI</td>
      <td>1</td>
      <td>10579.0</td>
      <td>37.900000</td>
    </tr>
    <tr>
      <th>Pitkin</th>
      <td>CO</td>
      <td>1</td>
      <td>10653.0</td>
      <td>8.900000</td>
    </tr>
    <tr>
      <th>Pine</th>
      <td>MN</td>
      <td>1</td>
      <td>9609.0</td>
      <td>21.600000</td>
    </tr>
    <tr>
      <th>Accomack</th>
      <td>VA</td>
      <td>1</td>
      <td>2899.0</td>
      <td>58.800000</td>
    </tr>
  </tbody>
</table>
<p>959 rows × 4 columns</p>
</div></div></div>
</div>
<p>If you remember the map of the US that we saw in the previous section, it is now more clear the Cook county in IL is likely the dark area we saw in our hexbin visualization of the data, as a dense population of breweries.</p>
<p>We can now ask ourselves where do we have the most brewries per population and add this column to our table</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;county_name&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> 
        <span class="n">brewry_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
        <span class="n">population_sum</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span>
        <span class="n">density_average</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">brewry_per_population</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">brewry_count</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">population_sum</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;brewry_per_population&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>brewry_count</th>
      <th>population_sum</th>
      <th>density_average</th>
      <th>brewry_per_population</th>
    </tr>
    <tr>
      <th>county_name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Keweenaw</th>
      <td>MI</td>
      <td>1</td>
      <td>87.0</td>
      <td>1.000000</td>
      <td>11.494253</td>
    </tr>
    <tr>
      <th>Wabasha</th>
      <td>MN</td>
      <td>1</td>
      <td>88.0</td>
      <td>29.500000</td>
      <td>11.363636</td>
    </tr>
    <tr>
      <th>Harding</th>
      <td>NM</td>
      <td>1</td>
      <td>139.0</td>
      <td>0.100000</td>
      <td>7.194245</td>
    </tr>
    <tr>
      <th>Koochiching</th>
      <td>MN</td>
      <td>1</td>
      <td>151.0</td>
      <td>334.400000</td>
      <td>6.622517</td>
    </tr>
    <tr>
      <th>Clearwater</th>
      <td>ID</td>
      <td>1</td>
      <td>164.0</td>
      <td>5.800000</td>
      <td>6.097561</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Cabarrus</th>
      <td>NC</td>
      <td>5</td>
      <td>299927.0</td>
      <td>256.800000</td>
      <td>0.016671</td>
    </tr>
    <tr>
      <th>Fort Bend</th>
      <td>TX</td>
      <td>6</td>
      <td>371516.0</td>
      <td>472.583333</td>
      <td>0.016150</td>
    </tr>
    <tr>
      <th>Chesapeake</th>
      <td>VA</td>
      <td>1</td>
      <td>65603.0</td>
      <td>155.100000</td>
      <td>0.015243</td>
    </tr>
    <tr>
      <th>Guadalupe</th>
      <td>TX</td>
      <td>7</td>
      <td>494106.0</td>
      <td>113.828571</td>
      <td>0.014167</td>
    </tr>
    <tr>
      <th>Hidalgo</th>
      <td>TX</td>
      <td>4</td>
      <td>287487.0</td>
      <td>798.050000</td>
      <td>0.013914</td>
    </tr>
  </tbody>
</table>
<p>959 rows × 5 columns</p>
</div></div></div>
</div>
<p>We can see, as it is often the case, that we have on the top and the bottom of the table counties with very few brewries. The top of the table of brewries per 1000 people is held by Keweenaw that was last on our previous table of counties by population. To avoid this, we can filter (using <em>query</em>) our table to counties that have more than 5 brewries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;county_name&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> 
        <span class="n">brewry_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
        <span class="n">population_sum</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span>
        <span class="n">density_average</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">brewry_per_population</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">brewry_count</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">population_sum</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;brewry_count &gt; 5&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;brewry_per_population&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>brewry_count</th>
      <th>population_sum</th>
      <th>density_average</th>
      <th>brewry_per_population</th>
    </tr>
    <tr>
      <th>county_name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Schuyler</th>
      <td>NY</td>
      <td>7</td>
      <td>15117.0</td>
      <td>26.285714</td>
      <td>0.463055</td>
    </tr>
    <tr>
      <th>Grafton</th>
      <td>NH</td>
      <td>7</td>
      <td>25969.0</td>
      <td>28.714286</td>
      <td>0.269552</td>
    </tr>
    <tr>
      <th>Windsor</th>
      <td>VT</td>
      <td>7</td>
      <td>28073.0</td>
      <td>36.228571</td>
      <td>0.249350</td>
    </tr>
    <tr>
      <th>Waldo</th>
      <td>ME</td>
      <td>7</td>
      <td>28697.0</td>
      <td>28.357143</td>
      <td>0.243928</td>
    </tr>
    <tr>
      <th>Grand</th>
      <td>CO</td>
      <td>7</td>
      <td>30992.0</td>
      <td>3.485714</td>
      <td>0.225865</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>St. Charles</th>
      <td>MO</td>
      <td>7</td>
      <td>356115.0</td>
      <td>426.171429</td>
      <td>0.019657</td>
    </tr>
    <tr>
      <th>Kings</th>
      <td>CA</td>
      <td>30</td>
      <td>1706298.0</td>
      <td>14137.416667</td>
      <td>0.017582</td>
    </tr>
    <tr>
      <th>Gwinnett</th>
      <td>GA</td>
      <td>6</td>
      <td>349573.0</td>
      <td>737.716667</td>
      <td>0.017164</td>
    </tr>
    <tr>
      <th>Fort Bend</th>
      <td>TX</td>
      <td>6</td>
      <td>371516.0</td>
      <td>472.583333</td>
      <td>0.016150</td>
    </tr>
    <tr>
      <th>Guadalupe</th>
      <td>TX</td>
      <td>7</td>
      <td>494106.0</td>
      <td>113.828571</td>
      <td>0.014167</td>
    </tr>
  </tbody>
</table>
<p>299 rows × 5 columns</p>
</div></div></div>
</div>
<p>And the winner is Schuyler county in New York, with 7 brewries and a 0.46 brewry for every 1,000 people</p>
</div>
<div class="section" id="geographic-mapping">
<h2>Geographic Mapping<a class="headerlink" href="#geographic-mapping" title="Permalink to this headline">¶</a></h2>
<p>The merge that we did allows us now to have geo location information for all the breweries, including the ones that didn’t have it in the original data set, as we have the geo location of the zip code area.</p>
<p>We can also add layers on real maps using the library GeoPandas. Let’s start with installing the library to our environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">geopandas</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: geopandas in /Users/guy/miniconda3/lib/python3.8/site-packages (0.8.1)
Requirement already satisfied: pandas&gt;=0.23.0 in /Users/guy/miniconda3/lib/python3.8/site-packages (from geopandas) (1.1.2)
Requirement already satisfied: fiona in /Users/guy/miniconda3/lib/python3.8/site-packages (from geopandas) (1.8.18)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pyproj&gt;=2.2.0 in /Users/guy/miniconda3/lib/python3.8/site-packages (from geopandas) (3.0.0.post1)
Requirement already satisfied: shapely in /Users/guy/miniconda3/lib/python3.8/site-packages (from geopandas) (1.7.1)
Requirement already satisfied: python-dateutil&gt;=2.7.3 in /Users/guy/miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23.0-&gt;geopandas) (2.8.1)
Requirement already satisfied: pytz&gt;=2017.2 in /Users/guy/miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23.0-&gt;geopandas) (2020.1)
Requirement already satisfied: numpy&gt;=1.15.4 in /Users/guy/miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23.0-&gt;geopandas) (1.19.2)
Requirement already satisfied: click-plugins&gt;=1.0 in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (1.1.1)
Requirement already satisfied: click&lt;8,&gt;=4.0 in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (7.1.2)
Requirement already satisfied: attrs&gt;=17 in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (20.2.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: munch in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (2.5.0)
Requirement already satisfied: cligj&gt;=0.5 in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (0.7.1)
Requirement already satisfied: certifi in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (2020.6.20)
Requirement already satisfied: six&gt;=1.7 in /Users/guy/miniconda3/lib/python3.8/site-packages (from fiona-&gt;geopandas) (1.14.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<p>We also need to install a library to handle geo coordinates</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">descartes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: descartes in /Users/guy/miniconda3/lib/python3.8/site-packages (1.1.0)
Requirement already satisfied: matplotlib in /Users/guy/miniconda3/lib/python3.8/site-packages (from descartes) (3.3.2)
Requirement already satisfied: certifi&gt;=2020.06.20 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (2020.6.20)
Requirement already satisfied: numpy&gt;=1.15 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (1.19.2)
Requirement already satisfied: cycler&gt;=0.10 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (0.10.0)
Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,&gt;=2.0.3 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (2.4.7)
Requirement already satisfied: python-dateutil&gt;=2.1 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (2.8.1)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (1.2.0)
Requirement already satisfied: pillow&gt;=6.2.0 in /Users/guy/miniconda3/lib/python3.8/site-packages (from matplotlib-&gt;descartes) (7.2.0)
Requirement already satisfied: six in /Users/guy/miniconda3/lib/python3.8/site-packages (from cycler&gt;=0.10-&gt;matplotlib-&gt;descartes) (1.14.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<p>We will import the library</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Create a data frame that is designed for geo data</p></li>
<li><p>Start with the enriched breweries data above</p></li>
<li><p>Define the geometry of the data from</p></li>
<li><p>x as the longitude (<em>lng</em> column)</p></li>
<li><p>y as the latitude (<em>lat</em> column)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">geopandas</span>
    <span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span><span class="p">,</span> 
    <span class="n">geometry</span><span class="o">=</span><span class="n">geopandas</span>
    <span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span>
        <span class="n">enriched_breweries_data</span><span class="o">.</span><span class="n">lng</span><span class="p">,</span> 
        <span class="n">enriched_breweries_data</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a geo dataframe for the world map from the built-in dataset of GeoPandas library</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">geopandas</span>
    <span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
        <span class="n">geopandas</span>
        <span class="o">.</span><span class="n">datasets</span>
        <span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_lowres&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Start with the world data frame</p></li>
<li><p>Filter it to use only the USA parts</p></li>
<li><p>Focus on the geometry boundaries of the map</p></li>
<li><p>Plot the map</p></li>
<li><p>using black color</p></li>
<li><p>and thin lines (0.2)</p></li>
<li><p>Now, plot the breweries data</p></li>
<li><p>on the above map</p></li>
<li><p>using red dots</p></li>
<li><p>and one pixel for each</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We restrict to USA</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">world</span>
    <span class="p">[</span><span class="n">world</span><span class="o">.</span><span class="n">iso_a3</span> <span class="o">==</span> <span class="s1">&#39;USA&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">boundary</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span> 
    <span class="n">gdf</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
        <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03.03_merge_46_0.png" src="../_images/03.03_merge_46_0.png" />
</div>
</div>
<p>This is a good start, but we can’t really use it. Let’s make it more usable to know where is the beer hub in the US.</p>
<ul class="simple">
<li><p>Create a 2D histogram based on the enriched breweries data</p></li>
<li><p>using x as latitude (<em>lat</em> column),</p></li>
<li><p>y as longtitude (<em>lng</em> column),</p></li>
<li><p>and 1000 bins for the histogram</p></li>
<li><p>Focus only on the main land using its coordinates</p></li>
<li><p>Then, create a smooth heat map from the histogram</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>

<span class="n">heatmap</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
    <span class="n">enriched_breweries_data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> 
    <span class="n">enriched_breweries_data</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">],</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
    <span class="nb">range</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>  <span class="c1"># North-South extent of US</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">]</span>  <span class="c1"># East-West extent of US, </span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">logheatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<span class="n">logheatmap</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">logheatmap</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">logheatmap</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">logheatmap</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>  <span class="c1"># smooth out peaks</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-24-785fa68b4e5e&gt;:14: RuntimeWarning: divide by zero encountered in log
  logheatmap = np.log(heatmap)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">world</span>
    <span class="p">[</span><span class="n">world</span><span class="o">.</span><span class="n">iso_a3</span> <span class="o">==</span> <span class="s1">&#39;USA&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">boundary</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> 
        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">logheatmap</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="o">-</span><span class="mi">65</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03.03_merge_49_0.png" src="../_images/03.03_merge_49_0.png" />
</div>
</div>
<p>We can clearly see the hubs in San Diego, New York, Illinois, and another one in Colorado.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="03.02_group_by.html" title="previous page">Split a Table into Groups</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Aiola Team<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>